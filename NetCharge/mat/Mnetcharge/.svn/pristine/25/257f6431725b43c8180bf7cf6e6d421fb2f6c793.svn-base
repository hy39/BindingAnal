% plot the netcharge vs ages
addpath(genpath('..'));
ranges = [
          1993.601 1994.6; 
          1994.601 1995.6;
          1995.601 1996.6;
          1996.601 1997.6;
          1997.601 1998.6;
          1998.601 1999.6;
          1999.601 2000.6;
          2000.601 2001.6;
          2001.601 2002.6;
          2002.601 2003.6; 
          2003.601 2004.6;
          2004.601 2005.6;
          ]
%ranges2 = [1993.601 2005.6];
dominance = [9 0;
             9 0;
             8 0;
             8 0;
             10 0;
             11 10;
             10 0;
             11 0;
             10 0;
             11 10;
             10 11;
             11 0];
         
         
ranges2 = [1993.601 2005.6];   
load('../../dat/h3n2_ny/hm_h3n2_ny_merged_data.mat');
hfig = figure;
i = 1;

y_lim = [39 43;
         40 44;
         39 43;
         37 41;
         39 43;
         37 41;
         37 41;
         37 41;
         36 40;
         34 38;
         30 38;
         30 38];
     
pvalue = [];
ptable = [];     
     
for i=1:length(ranges(:,1))
    ranges2 = ranges(i,:);
    ngs_index = 4;
    charge_index = 3; %netcharge
    %charge_index = 5; %total charged amino acids
    ageid = 1;
    K_index = 6; % 1:age, 2:isolation date, 6:times of previouis infection 
    index = K_index; % 1:age, 2:isolation date, 6:times of previouis infection 
    bding_charge_index = 7;
    bding_total_index = 9;
    Y_IDX = bding_total_index;
    min_no = 12;
    
    % #NGS=8
    TF = find(Viruses(:,2)>ranges2(1,1) & Viruses(:,2)<ranges2(1,2) &  Viruses(:,1)~=0);
    viruses = Viruses(TF,:);
    if i==1
        subplot(3,4,1);
        set(gca,'YLim',y_lim(i,:));
        %set(gca,'YLim',[10 14]);
        hold;
    elseif i==2
        subplot(3,4,2);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==3
        subplot(3,4,3);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==4
        subplot(3,4,4);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==5
        subplot(3,4,5);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==6
        subplot(3,4,6);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==7
        subplot(3,4,7);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==8
        subplot(3,4,8);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==9
        subplot(3,4,9);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==10
        subplot(3,4,10);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==11
        subplot(3,4,11);
        set(gca,'YLim',y_lim(i,:));
        hold;
    elseif i==12
        subplot(3,4,12);
        set(gca,'YLim',y_lim(i,:));
        hold;
    end
    
    dm_ngs = dominance(i,:);
    ages_lim = 70;
    % Viral Strains with #NGS = 7
    if dm_ngs(1) == 7 | dm_ngs(2) == 7
    x1 = [0:1:100]
    viruses_ngs = viruses(find(viruses(:,ngs_index)==7 & viruses(:,ageid)<=ages_lim),:);
    %if(length(viruses_ngs(:,1))>min_no)
    x = viruses_ngs(:,index);
    y = viruses_ngs(:,Y_IDX);
    plot(viruses_ngs(:,index), viruses_ngs(:,Y_IDX) , 'Ro');
    if(length(viruses_ngs(:,1))>min_no)
        X = [ones(size(x)) x]; 
        [b,bint,r,rint,stats] = regress(y,X);
        x1fit = 0:ages_lim;
        YFIT = b(1) + b(2)*x1fit;
        plot(x1fit,YFIT, 'R-');
        b(2)
        stats(3) 
    end
    
    j1 = length(pvalue)+1;
    pvalue(j1).season = ranges2;
    pvalue(j1).ngs = 7;
    pvalue(j1).slope = b(2);
    pvalue(j1).p = stats(3);
    ptable(j1,:)[]
    end
    
    if dm_ngs(1) == 8 | dm_ngs(2) == 8
    % Viral Strains with #NGS = 8
    viruses_ngs = viruses(find(viruses(:,ngs_index)==8 & viruses(:,ageid)<=ages_lim),:);
    %if(length(viruses_ngs(:,1))>min_no)
    x = viruses_ngs(:,index);
    y = viruses_ngs(:,Y_IDX);
    plot(viruses_ngs(:,index), viruses_ngs(:,Y_IDX) , 'Go');
    if(length(viruses_ngs(:,1))>min_no)
        X = [ones(size(x)) x]; 
        [b,bint,r,rint,stats] = regress(y,X);
        x1fit = 0:ages_lim;
        YFIT = b(1) + b(2)*x1fit;
        plot(x1fit,YFIT, 'G-');
        b(2)
        stats(3) 
    end
    
    j1 = length(pvalue)+1;
    pvalue(j1).season = ranges2;
    pvalue(j1).ngs = 8;
    pvalue(j1).slope = b(2);
    pvalue(j1).p = stats(3);
    end
    
    if dm_ngs(1) == 9 | dm_ngs(2) == 9
    % Viral Strains with #NGS = 9
    viruses_ngs = viruses(find(viruses(:,ngs_index)==9 & viruses(:,ageid)<=ages_lim),:);
    %if(length(viruses_ngs(:,1))>min_no)
    x = viruses_ngs(:,index);
    y = viruses_ngs(:,Y_IDX);
    plot(viruses_ngs(:,index), viruses_ngs(:,Y_IDX) , 'Bo');
    if(length(viruses_ngs(:,1))>min_no)
        X = [ones(size(x)) x]; 
        [b,bint,r,rint,stats] = regress(y,X);
        x1fit = 0:ages_lim;
        YFIT = b(1) + b(2)*x1fit;
        plot(x1fit,YFIT, 'B-');
        b(2)
        stats(3) 
    end
    j1 = length(pvalue)+1;
    pvalue(j1).season = ranges2;
    pvalue(j1).ngs = 9;
    pvalue(j1).slope = b(2);
    pvalue(j1).p = stats(3);
    end
    
    if dm_ngs(1) == 10 | dm_ngs(2) == 10
    % Viral Strains with #NGS = 10
    viruses_ngs = viruses(find(viruses(:,ngs_index)==10 & viruses(:,ageid)<=ages_lim),:);
    %if(length(viruses_ngs(:,1))>min_no)
    x = viruses_ngs(:,index);
    y = viruses_ngs(:,Y_IDX);
    plot(viruses_ngs(:,index), viruses_ngs(:,Y_IDX) , 'Co');
    if(length(viruses_ngs(:,1))>min_no)
        X = [ones(size(x)) x]; 
        [b,bint,r,rint,stats] = regress(y,X);
        x1fit = 0:ages_lim;
        YFIT = b(1) + b(2)*x1fit;
        plot(x1fit,YFIT, 'C-');
        b(2)
        stats(3) 
    end
    j1 = length(pvalue)+1;
    pvalue(j1).season = ranges2;
    pvalue(j1).ngs = 10;
    pvalue(j1).slope = b(2);
    pvalue(j1).p = stats(3);
    end
    
    if dm_ngs(1) == 11 | dm_ngs(2) == 11
    % Viral Strains with #NGS = 11
    viruses_ngs = viruses(find(viruses(:,ngs_index)==11 & viruses(:,ageid)<=ages_lim),:);
    %if(length(viruses_ngs(:,1))>min_no)
    x = viruses_ngs(:,index);
    y = viruses_ngs(:,Y_IDX);
    plot(viruses_ngs(:,index), viruses_ngs(:,Y_IDX) , 'Ko');
    if(length(viruses_ngs(:,1))>min_no)
        X = [ones(size(x)) x]; 
        [b,bint,r,rint,stats] = regress(y,X);
        x1fit = 0:ages_lim;
        YFIT = b(1) + b(2)*x1fit;
        plot(x1fit,YFIT, 'K-');
        b(2)
        stats(3) 
    end
    j1 = length(pvalue)+1;
    pvalue(j1).season = ranges2;
    pvalue(j1).ngs = 11;
    pvalue(j1).slope = b(2);
    pvalue(j1).p = stats(3);
    end
    
    if dm_ngs(1) == 12 | dm_ngs(2) == 12
    % Viral Strains with #NGS = 12
    viruses_ngs = viruses(find(viruses(:,ngs_index)==12 & viruses(:,ageid)<=ages_lim),:);
    %if(length(viruses_ngs(:,1))>min_no)
    x = viruses_ngs(:,index);
    y = viruses_ngs(:,Y_IDX);
    plot(viruses_ngs(:,index), viruses_ngs(:,Y_IDX) , 'Yo');
    if(length(viruses_ngs(:,1))>min_no)
        X = [ones(size(x)) x]; 
        [b,bint,r,rint,stats] = regress(y,X);
        x1fit = 0:ages_lim;
        YFIT = b(1) + b(2)*x1fit;
        plot(x1fit,YFIT, 'Y-');
        b(2)
        stats(3) 
    end
    j1 = length(pvalue)+1;
    pvalue(j1).season = ranges2;
    pvalue(j1).ngs = 12;
    pvalue(j1).slope = b(2);
    pvalue(j1).p = stats(3);
    end

    
    % Total viral strains
    viruses_ngs = viruses;
    if(length(viruses_ngs(:,1))>min_no)
    x = viruses_ngs(:,index);
    y = viruses_ngs(:,Y_IDX);
    if(length(viruses_ngs(:,1))>min_no)
        X = [ones(size(x)) x]; 
        [b,bint,r,rint,stats] = regress(y,X);
        x1fit = 0:ages_lim;
        YFIT = b(1) + b(2)*x1fit;
        %plot(x1fit,YFIT, 'color', [0.5 0.5 0.5]);
        b(2)
        stats(3) 
    end
    end
    
    
    
    %for v=1:length(viruses(:,1))
    %    if viruses(v,ngs_index)==7
    %        plot(viruses(v,index), viruses(v,3) , 'Ro');
    %    elseif viruses(v,ngs_index)==8
    %        plot(viruses(v,index), viruses(v,3) , 'Go');
    %    elseif viruses(v,ngs_index)==9
    %        plot(viruses(v,index), viruses(v,3) , 'Bo');
    %    elseif viruses(v,ngs_index)==10
    %        plot(viruses(v,index), viruses(v,3) , 'Co');
    %    elseif viruses(v,ngs_index)==11
    %        plot(viruses(v,index), viruses(v,3) , 'Ko');
    %    elseif viruses(v,ngs_index)==12
    %        plot(viruses(v,index), viruses(v,3) , 'Yo');
    %    end
    %end

%axis([ 0, 0, 14, 20])
set(gca,'XLim',[-0.5 12])
%hFig = figure(1);
pos1 = [100   100   1480   762];
set(hfig,'Position',pos1); 

%set(gca,'YLim',[8 15]) %set the range
%set(gca,'YLim',[68 75]) %set the range
%x_scale = [1996 1997 1998 1999 2000 2001 2002 2003 2004 2005 2006];
%x_label = ['1995/1996'; '1996/1997'; '1997/1998'; '1998/1999'; '1999/2000'; '2000/2001'; '2001/2002'; '2002/2003'; '2003/2004'; '2004/2005'; '2005/2006'];
%set(gca,'XTick',x_scale);
%set(gca,'XTickLabel',x_label);
title([num2str(fix(ranges2(ageid,1))) '/' num2str(fix(ranges2(ageid,2)))]);

save('h3n2_ny_bding_K_pvalue.mat', 'pvalue');
end
clear all;